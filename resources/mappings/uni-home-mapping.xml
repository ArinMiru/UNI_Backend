<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="uni-home-mapping">
  
  <select id="selectOpenBubInfo" resultType="HashMap" parameterType="HashMap">
    SELECT 
		*
	FROM (
		SELECT
			ROW_NUMBER() OVER() AS R_NUM
			,MEMB_ID
			,CRE_SEQ	
			,TIT
			,CONT
			,LIKE_CNT
			,DATE_FORMAT(CRE_DAT,'%Y-%m-%d %H:%i') AS CRE_DAT
		FROM OPEN_BUB_BAS
		WHERE MEMB_SC_CD = #{MEMB_SC_CD}
		<if test='"00".equals(TIT_CD) or "01".equals(TIT_CD)'>
		AND MEMB_DEP_CD = #{MEMB_DEP_CD}
        </if>		
		ORDER BY CRE_DAT DESC
 	) A
 	<![CDATA[
	WHERE A.R_NUM >= (IF(1 = #{REQ_PAGE},0,#{REQ_PAGE}-1) * IF(1 = #{REQ_PAGE},0,#{LIST_UNIT_CNT})) + 1
	AND A.R_NUM <= #{REQ_PAGE} * #{LIST_UNIT_CNT}
	]]>
  </select>
  
  <select id="selectOpenImgInfo" resultType="HashMap" parameterType="HashMap">
    SELECT 
		B.FILE_PATH
		,B.IMG_SEQ
	FROM OPEN_BUB_BAS A , OPEN_BUB_IMG_HIST B
	WHERE 	B.CRE_SEQ = A.CRE_SEQ
	AND 	A.MEMB_SC_CD = #{MEMB_SC_CD}
	<if test='"00".equals(TIT_CD) or "01".equals(TIT_CD)'>
	AND 	A.MEMB_DEP_CD = #{MEMB_DEP_CD}
	</if>
	AND 	A.CRE_SEQ = #{CRE_SEQ}
  </select>
  
  <select id="selectOpenBubSeq" resultType="long">
    SELECT 
		NEXTVAL(open_cre_seq)
	FROM DUAL
  </select>
  
  <insert id="insertOpenBubInfo" parameterType="HashMap">
    INSERT INTO OPEN_BUB_BAS(
    	MEMB_SC_CD
		,MEMB_DEP_CD
		,MEMB_ID
		,CRE_SEQ
		,LIKE_CNT
		,TIT
		,CONT
		,CRE_DAT    
    ) VALUES (
    	#{MEMB_SC_CD}
		,#{MEMB_DEP_CD}
		,#{MEMB_ID}
		,#{CRE_SEQ}
		,0
		,#{TIT}
		,#{CONT}
		,SYSDATE()
    )
  </insert>
  
  <insert id="insertOpenImgInfo" parameterType="HashMap">
    INSERT INTO OPEN_BUB_IMG_HIST(
    	CRE_SEQ
		,IMG_SEQ
		,ORIG_FILE_NM
		,MOD_FILE_NM
		,FILE_PATH
		,CRE_DAT
    ) VALUES (
    	#{CRE_SEQ}
		,NEXTVAL(open_img_seq)
		,#{ORIG_FILE_NM}
		,#{MOD_FILE_NM}
		,#{FILE_PATH}
		,SYSDATE()
    )
  </insert>
  
  <update id="updateOpenBubInfo" parameterType="HashMap">
    UPDATE OPEN_BUB_BAS SET
    	TIT 	= #{TIT}
		,CONT 	= #{CONT}
    WHERE 	MEMB_SC_CD 	= #{MEMB_SC_CD}
	AND		MEMB_DEP_CD = #{MEMB_DEP_CD}
	AND		MEMB_ID 	= #{MEMB_ID}
	AND		CRE_SEQ 	= #{CRE_SEQ}
  </update>
  
  <delete id="deleteOpenImgInfo" parameterType="HashMap">
    DELETE FROM OPEN_BUB_IMG_HIST 
    WHERE 	CRE_SEQ 	= #{CRE_SEQ}
	AND		IMG_SEQ 	= #{IMG_SEQ}
  </delete>
  
   <delete id="deleteOpenBubInfo" parameterType="HashMap">
    DELETE FROM OPEN_BUB_BAS 
    WHERE 	MEMB_SC_CD 	= #{MEMB_SC_CD}
	AND		MEMB_DEP_CD = #{MEMB_DEP_CD}
	AND		MEMB_ID 	= #{MEMB_ID}
	AND		CRE_SEQ 	= #{CRE_SEQ}
  </delete>
  
  <delete id="deleteOpenAllImgInfo" parameterType="HashMap">
    DELETE FROM OPEN_BUB_IMG_HIST 
    WHERE 	CRE_SEQ 	= #{CRE_SEQ}
  </delete>
  
  <select id="selectOpenDelImgInfo" resultType="String" parameterType="HashMap">
    SELECT 	FILE_PATH
    FROM 	OPEN_BUB_IMG_HIST 
    WHERE 	CRE_SEQ 	= #{CRE_SEQ}
	AND		IMG_SEQ 	= #{IMG_SEQ}
  </select>
  
  <select id="selectOpenDelAllImgInfo" resultType="String" parameterType="HashMap">
    SELECT 	FILE_PATH
    FROM 	OPEN_BUB_IMG_HIST 
    WHERE 	CRE_SEQ 	= #{CRE_SEQ}
  </select>
  
</mapper>